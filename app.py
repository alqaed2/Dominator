from flask import Flask, render_template, request, jsonify
import google.generativeai as genai
import os

app = Flask(__name__)

# --- ุฅุนุฏุงุฏุงุช ุงููุฏูุฑ ุงูุชููู ---
# ูุฑุงุกุฉ ุงูููุชุงุญ ูู ุจูุฆุฉ ุงูุณูุฑูุฑ ุงูุขููุฉ
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY')

# ุงูุชุญูู ูู ูุฌูุฏ ุงูููุชุงุญ
if not GEMINI_API_KEY:
    # ูุฐุง ูุฌุฑุฏ ุญู ูุคูุช ููู ูุง ูุชููู ุงูุณูุฑูุฑุ ููู ูุฌุจ ุถุจุท ุงูููุชุงุญ ูู Render
    print("โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุงุญ API ูู ุงูุจูุฆุฉ!")

# ุฅุนุฏุงุฏ ุงููุญุฑู
try:
    genai.configure(api_key=GEMINI_API_KEY)
    # ูุณุชุฎุฏู ููุฏูู ุณุฑูุน ูุฐูู ููุนูููุงุช ุงููุชุณูุณูุฉ
    model = genai.GenerativeModel('gemini-1.5-flash')
except Exception as e:
    print(f"โ ุฎุทุฃ ูู ุฅุนุฏุงุฏ Gemini: {e}")

# --- ุงูููุธููู ุงูุงูุชุฑุงุถููู (The AI Agents) ---

# 1. ุงููุงุชุจ ุงููุจุฏุน
CREATOR_PROMPT = """
ุฃูุช ูุงุชุจ ูุญุชูู ููุฑูุณู (Viral Content Creator) ูููุตุงุช LinkedIn ู Twitter.
ูููุชู: ูุชุงุจุฉ ูุณูุฏุฉ ุฃูููุฉ ุจูุงุกู ุนูู ููุฑุฉ ุงููุณุชุฎุฏู.
ุงูุฃุณููุจ: ุฌุฑูุกุ ูุณุชุฎุฏู ุงููุตุต (Storytelling)ุ ููุจุฏุฃ ุจุฌููุฉ ุฎุงุทูุฉ (Hook).
ูุง ุชูุชู ุจุงูุชูุณูู ุงูุขูุ ุฑูุฒ ููุท ุนูู ููุฉ ุงูููุฑุฉ ูุงูุนุงุทูุฉ.
"""

# 2. ุงููุงูุฏ ุงูุดุฑุณ (ุณุฑ ุงูุฌูุฏุฉ)
CRITIC_PROMPT = """
ุฃูุช ุฎุจูุฑ ุฎูุงุฑุฒููุงุช ูููุชูุฏ ูุญุชูู ุดุฑุณ.
ูููุชู: ูุฑุงุกุฉ ุงููุณูุฏุฉ ูุชูููููุง ุจุตุฑุงูุฉ.
ูุง ุชุนุฏ ูุชุงุจุฉ ุงููุต. ููุท ูุฏู ุชูุฑูุฑุงู ูุตูุฑุงู ุฌุฏุงู (ููุงุท ูุญุฏุฏุฉ):
1. ูู ุงูู Hook ููู ุจูุง ูููู ูุฅููุงู ุงูู Scrollุ
2. ูู ุงููุต ุณูู ุงููุฑุงุกุฉ (Skimmable)ุ
3. ูุง ูู ุงููููุงุช ุงูุถุนููุฉ ุงูุชู ูุฌุจ ุญุฐููุงุ
ุฃุนุทู ุชูุฌููุงุช ูุจุงุดุฑุฉ ูููุญุฑุฑ.
"""

# 3. ุงููุญุฑุฑ ุงูููุงุฆู
EDITOR_PROMPT = """
ุฃูุช ุงููุญุฑุฑ ุงูุชูููุฐู (Executive Editor).
ูููุชู: ุฃุฎุฐ "ุงููุณูุฏุฉ" ู "ููุงุญุธุงุช ุงููุงูุฏ" ูุตูุงุบุฉ ุงูููุดูุฑ ุงูููุงุฆู ุงููุซุงูู.
ุงูููุงุนุฏ:
1. ุทุจู ูุตุงุฆุญ ุงููุงูุฏ ููุฑุงู.
2. ุงุณุชุฎุฏู ุชูุณููุงู ูุฑูุญุงู ููุนูู (ูุฑุงุบุงุช ุจูู ุงูุฃุณุทุฑ).
3. ุฃุถู ุฅูููุฌู ููุงุณุจ (ุจุฏูู ูุจุงูุบุฉ).
4. ุฃุถู 3-5 ูุงุดุชุงุบุงุช ูููุฉ ูู ุงูููุงูุฉ.
5. ุฃุถู ุงูุชูููุน: "โก Engineered by AI Dominator"
"""

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/generate', methods=['POST'])
def generate():
    try:
        data = request.json
        original_text = data.get('text', '')

        if not original_text:
            return jsonify({'error': 'ุงููุต ูุงุฑุบ! ุงูุชุจ ููุฑุฉ ููุจุฏุฃ.'}), 400

        # ุงููุฑุญูุฉ 1: ุงููุงุชุจ
        print("๐ง 1. ุงููุงุชุจ ูุจุฏุฃ ุงูุนูู...")
        creator_resp = model.generate_content(f"{CREATOR_PROMPT}\n\nููุฑุฉ ุงููุณุชุฎุฏู: {original_text}")
        draft = creator_resp.text

        # ุงููุฑุญูุฉ 2: ุงููุงูุฏ
        print("๐ง 2. ุงููุงูุฏ ูุญูู ุงููุต...")
        critic_resp = model.generate_content(f"{CRITIC_PROMPT}\n\nุงููุณูุฏุฉ ูููุฑุงุกุฉ:\n{draft}")
        feedback = critic_resp.text

        # ุงููุฑุญูุฉ 3: ุงููุญุฑุฑ
        print("โจ 3. ุงููุญุฑุฑ ูุถุน ุงูููุณุงุช ุงูุฃุฎูุฑุฉ...")
        final_prompt = f"{EDITOR_PROMPT}\n\nุงููุณูุฏุฉ ุงูุฃุตููุฉ:\n{draft}\n\nุชูุฌููุงุช ุงููุงูุฏ ุงูุตุงุฑูุฉ:\n{feedback}"
        final_resp = model.generate_content(final_prompt)
        viral_content = final_resp.text

        # ุฅุฑุฌุงุน ุงููุชูุฌุฉ + ุชูุฑูุฑ ุงููุงูุฏ (ููุฑุงู ุงููุณุชุฎุฏู)
        return jsonify({
            'result': viral_content,
            'debug': feedback
        })

    except Exception as e:
        print(f"โ Error: {e}")
        return jsonify({'error': f"ุญุฏุซ ุฎุทุฃ ูู ุงููุธุงู: {str(e)}"}), 500

if __name__ == '__main__':
    # ุชุดุบูู ุงูุชุทุจูู (Render ุณูุชุฌุงูู ูุฐุง ููุณุชุฎุฏู Gunicorn)
    app.run(debug=True)
