from flask import Flask, render_template, request, jsonify
import google.generativeai as genai
import os

app = Flask(__name__)

# --- ุฅุนุฏุงุฏุงุช ุงููุฏูุฑ ุงูุชููู ---
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY')

if not GEMINI_API_KEY:
    print("โ๏ธ ุชุญุฐูุฑ: ููุชุงุญ API ููููุฏ!")

try:
    genai.configure(api_key=GEMINI_API_KEY)
    # ๐ฅ ุงูุงูุชุดุงู ุงูุฐูู: ูุณุชุฎุฏู ูุฐุง ุงูููุฏูู ูุฃูู ุธูุฑ ูู ูุงุฆูุชู ููู ููุชูู ุญุตุฉ ุถุฎูุฉ
   # --- ุงูุชุนุฏูู ุงูุฐูู: ูุฑุงุกุฉ ุงูููุฏูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ---
# ุฅุฐุง ูู ูุฌุฏ ูุชุบูุฑุงูุ ุณูุณุชุฎุฏู 'gemini-2.5-flash' ูุงุญุชูุงุท
MODEL_NAME = os.environ.get('GEMINI_MODEL', 'gemini-2.5-flash')

try:
    genai.configure(api_key=GEMINI_API_KEY)
    print(f"๐ค ุฌุงุฑู ุชุดุบูู ุงููุธุงู ุจุงุณุชุฎุฏุงู ุงูููุฏูู: {MODEL_NAME}")
    model = genai.GenerativeModel(MODEL_NAME)
except Exception as e:
    print(f"โ ุฎุทุฃ ูู ุฅุนุฏุงุฏ Gemini: {e}")
except Exception as e:
    print(f"โ ุฎุทุฃ ูู ุฅุนุฏุงุฏ Gemini: {e}")

# --- ุนูู ุงููุธุงู (The Core Logic) ---

# 1. ูุญูู ุงูู DNA (ุงููุณุฎุฉ ุงููุชูุฏูุฉ)
STYLE_ANALYZER_PROMPT = """
ุฃูุช ุจุฑูููุณูุฑ ูู ุงููุบููุงุช ูุชุญููู ุงูุดุฎุตูุงุช ุงูุฑูููุฉ.
ูููุชู: ุงุณุชุฎุฑุงุฌ "ุงูุจุตูุฉ ุงููุฑุงุซูุฉ ูููุต" (Textual DNA) ูู ุงูุนููุงุช ุงูููุฏูุฉ.

ุญูู ุจุฏูุฉ ูุชูุงููุฉ:
1. **ุงูุชูููุน ุงูุนุงุทูู (Emotional Signature):** ูู ุงููุงุชุจ ุนุฏูุงููุ ููููุ ุณุงุฎุฑุ ุฃู ูุงุฏุฆุ
2. **ููุฏุณุฉ ุงูุฌููุฉ (Sentence Engineering):** ูู ูุณุชุฎุฏู ุฌููุงู ูุตูุฑุฉ ูุซู ุงูุฑุตุงุตุ ุฃู ููุฑุงุช ุณุฑุฏูุฉ ุทูููุฉุ
3. **ุงูููุฑุฏุงุช ุงูุฎุงุตุฉ (Lexicon):** ูุง ูู ุงููููุงุช ุงูุชู ููุฑุฑูุงุ (ูุซูุงู: "ูุง ุณุงุฏุฉ"ุ "ุงูุณุฑ ูู"ุ ุฅูููุฌู ูุนูู ๐).

ุงููุฎุฑุฌ ุงููุทููุจ: ุงูุชุจ "ุฏููู ุชููุต ุงูุดุฎุตูุฉ" (Persona Guide) ุงูุฐู ูููููู ุฅุนุทุงุคู ููุงุชุจ ุขุฎุฑ ููุตุจุญ ูุณุฎุฉ ุทุจู ุงูุฃุตู ูู ูุฐุง ุงูุดุฎุต.
"""

# 2. ุงููุงุชุจ (ุงููุชููุต)
CREATOR_PROMPT = """
ุฃูุช ูุงุชุจ ุดุจุญู (Ghostwriter) ูุญุชุฑู.
ูููุชู: ูุชุงุจุฉ ููุดูุฑ ุฌุฏูุฏ ุชูุงูุงูุ ูููู ูุฌุจ ุฃู ูุธู ุงููุงุฑุฆ ุฃู [ุตุงุญุจ ุงูุฃุณููุจ ุงูุฃุตูู] ูู ูู ูุชุจู.

โ๏ธ ุฏููู ุชููุต ุงูุดุฎุตูุฉ (DNA):
{style_dna}

ุงูููุถูุน ุงููุทููุจ: {topic}

ุงูููุงุนุฏ:
- ุงุจุฏุฃ ุจู Hook ููู ุฌุฏุงู ุจููุณ ุฃุณููุจ ุงูุดุฎุตูุฉ.
- ูุง ุชุฎุฑุฌ ุนู ุงูุดุฎุตูุฉ ุฃุจุฏุงู.
"""

# 3. ุงููุงูุฏ (ุญุงุฑุณ ุงูุฌูุฏุฉ)
CRITIC_PROMPT = """
ุฃูุช ูุฏูุฑ ุชุญุฑูุฑ ุตุงุฑู.
ูุงุฑู "ุงููุณูุฏุฉ" ุจู "ุฏููู ุงูุฃุณููุจ".
ูู ูุฌุญ ุงููุงุชุจ ูู ุงูุชููุตุ
ุงูุชุจ ุชูุฑูุฑุงู ููุฏูุงู ุณุฑูุนุงู:
1. ูุณุจุฉ ุชุทุงุจู ุงูุฃุณููุจ (0-100%).
2. ูุง ุงูุฐู ูุจุฏู ูุตุทูุนุงู ููุฌุจ ุชุนุฏูููุ
"""

# 4. ุงููุญุฑุฑ (ุงููุฎุฑุฌ ุงูููุงุฆู)
EDITOR_PROMPT = """
ุฃูุช ุงููุญุฑุฑ ุงูููุงุฆู.
ุฃุนุฏ ุตูุงุบุฉ ุงููุต ููููู ุฌุงูุฒุงู ูููุดุฑ (Viral Ready).
ุทุจู ููุฏ ุงููุฏูุฑุ ูุญุงูุธ ุนูู ุฑูุญ ุงูุดุฎุตูุฉ.
ุฃุถู ุงูุชูููุน: โก Engineered by AI Dominator
"""

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/analyze-style', methods=['POST'])
def analyze_style():
    try:
        data = request.json
        text_samples = data.get('text', '')
        
        # ููุง ุงููุณุชูุจู: ูู ุฃุฑุณู ุงููุณุชุฎุฏู ุฑุงุจุทุงูุ ุณูููู ุจุฌูุจู (ูุงุญูุงู)
        # ุญุงููุงู ูุญูู ุงููุต ุงูููุณูุฎ
        if len(text_samples) < 50:
             return jsonify({'error': 'ุงููุต ูุตูุฑ ุฌุฏุงู ููุชุญููู! ุงูุตู 3 ููุดูุฑุงุช ุนูู ุงูุฃูู.'}), 400

        print("๐งฌ ุฌุงุฑู ุงุณุชุฎุฑุงุฌ ุงูุจุตูุฉ ุงููุฑุงุซูุฉ...")
        response = model.generate_content(f"{STYLE_ANALYZER_PROMPT}\n\nุนููุงุช ูู ูุชุงุจุงุช ุงููุณุชุฎุฏู:\n{text_samples}")
        return jsonify({'style_dna': response.text})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/generate', methods=['POST'])
def generate():
    try:
        data = request.json
        topic = data.get('text', '')
        style_dna = data.get('style', '')

        if not topic:
            return jsonify({'error': 'ุงููุต ูุงุฑุบ!'}), 400

        # ุฅุฐุง ูู ูุญูู ุงูุฃุณููุจุ ูุณุชุฎุฏู ุฃุณููุจุงู ุงูุชุฑุงุถูุงู ูููุงู
        if not style_dna:
            style_dna = "ุฃุณููุจ ููุงุฏูุ ููููุ ููุจุงุดุฑ. ุฌูู ูุตูุฑุฉ ููููุฉ."

        # 1. ุงููุงุชุจ
        print("โ๏ธ ุงููุงุชุจ ูุชููุต ุงูุดุฎุตูุฉ...")
        creator_resp = model.generate_content(CREATOR_PROMPT.format(style_dna=style_dna, topic=topic))
        draft = creator_resp.text

        # 2. ุงููุงูุฏ
        print("๐ง ุงููุงูุฏ ููุญุต ุงูุชุทุงุจู...")
        critic_resp = model.generate_content(f"{CRITIC_PROMPT}\nุงูุฃุณููุจ ุงููุทููุจ:\n{style_dna}\nุงููุณูุฏุฉ:\n{draft}")
        feedback = critic_resp.text

        # 3. ุงููุญุฑุฑ
        print("โจ ุงููุญุฑุฑ ูููู ุงูุนูู...")
        final_resp = model.generate_content(f"{EDITOR_PROMPT}\nุงููุณูุฏุฉ:\n{draft}\nุงูููุฏ:\n{feedback}")
        
        return jsonify({
            'result': final_resp.text,
            'debug': feedback
        })

    except Exception as e:
        # ุงูุชุนุงูู ุงูุฐูู ูุน ุงูุฃุฎุทุงุก
        err_msg = str(e)
        if "429" in err_msg:
            return jsonify({'error': '๐ฆ ุถุบุท ุนุงูู ุนูู ุงูุณูุฑูุฑ. ุงูุชุธุฑ ุฏูููุฉ ูุญุงูู ูุฌุฏุฏุงู.'}), 429
        return jsonify({'error': err_msg}), 500

if __name__ == '__main__':
    app.run(debug=True)


