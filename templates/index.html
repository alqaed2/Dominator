<!-- استبدل فقط دالة openModal في ملف index.html بهذا الكود المحصن -->
<script>
    function openModal() {
        if(!lastAlchemyResult) return;
        document.getElementById('superPostModal').style.display = 'flex';
        document.getElementById('superPostContent').innerText = lastAlchemyResult.super_
        except Exception as e:
            print(f"Scraper Logic Log: {e}")

    # جينات بديلة عالية الجودة بروابط حقيقية مشهورة في حال فشل الـ API
    return [
        {
            "text": f"استراتيجية اختراق الأسواق في {niche} لعام 2026...",
            "engagement": "180K",
            "author": "Strategic_Vault",
            "url": f"https://x.com/search?q={niche}&f=live",
            "score": 98
        },
        {
            "text": f"لماذا ينهار المنافسون في {niche}؟ التحليل الكامل هنا.",
            "engagement": "95K",
            "author": "Market_Oracle",
            "url": f"https://x.com/search?q={niche}&f=top",
            "score": 92
        }
    ]

@app.route("/")
def home(): return render_template("index.html")

@app.route("/alchemy/discover", methods=["POST"])
def discover():
    data = request.get_json(silent=True) or {}
    niche = data.get("post;
        
        let html = "";
        lastAlchemyResult.sources.forEach(s => {
            // تحديد نوع الرابط واسمه
            const linkText = s.is_live ? "زيارة المنشور الأصلي <i class='fas fa-external-link-alt'></i>" : "مسح السوق (X Search) <i class='fas fa-search'></i>";
            const borderColor = s.is_live ? "var(--neon-blue)" : "var(--neon-red)";
            
            html += `
            <div class="source-niche", "ريادة الأعمال")
    posts = fetch_live_dna(niche)
    fusion = alchemy_fusion_core(posts, niche)
    output = get_ai_response_nebula(f"{WPIL_DOMINATOR_SYSTEM}\n{fusion['synthesis_task']}")
    return jsonify({"super_post": output, "sources": posts, "trace": fusion["logic_trace"]}), 200

@app.route("/generate_all", methods=["POST"])
def generate():
    data = request.get_json(silent=True) or {}
    idea = data.get("text", "الهيمنة")
    prompt = f"{WPIL_DOMINATOR_SYSTEM}\nتوليد حزمة سيادية لـ [LINKEDIN], [TWITTER], [TIKTOK] للفكرة: {idea}"
    raw = get_ai_response_nebula(prompt)
    
    # تفكيك المخرجات برمجياً لضمان التبويبات
    parts = {"linkedin": "", "twitter": "", "tiktok": ""}
    for p in parts:
        match = re.search(rf"\[{p.upper()}\](.*?)(\[|$)", raw, re.S | re.I)
        parts[p] =item" style="border-left: 4px solid ${borderColor};">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="color:var(--neon-blue); font-weight:700;">@${s.author}</span>
                    <a href="${s.url}" target="_blank" rel="noopener noreferrer" 
                       style="color:#fff; font-size:11px; text-decoration:none; background:${s.is_live ? '#0055ff' : '#333'}; padding:4px 10px; border-radius:5px; font-weight:700;">
 match.group(1).strip() if match else "فشل استخراج القسم"
        
    brain = strategic_intelligence_core(idea)
    return jsonify({**parts, "video_prompt": brain["video_segments"]}), 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.getenv("PORT", 5000)))
