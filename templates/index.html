<!-- استبدل قسم الـ Script في ملف index.html بهذا الكود المحصن -->
<script>
    async function triggerDiscovery() {
        const btn = document.getElementById('discoverBtn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-brain fa-spin"></i> جاري التحليل...';
        try {
            const res = await fetch('/alchemy/discover', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({niche: document.getElementById('niche').value, target_data: document.getElementById('targetData').value})
            });
            const data = await res.json();
            if(data.status === 'success') {
                document.getElementById('inputText').value = data.super_post;
                document.getElementById('goldSuggestions').innerHTML = '<div style="color:var(--neon-blue); margin-top:10px;">✅ تم استخلاص الجينات بنجاح!</div>';
            }
        } catch (e) { alert("فشل الاتصال بمحرك Alchemy"); }
        btn.disabled = false; btn.innerHTML = "اكتشاف / استهداف";
    }

    async function startDominanceEngine() {
        const text = document.getElementById('inputText').value;
        if(!text) return alert("أدخل فكرة أولاً");
        
        const btn = document.getElementById('generateBtn');
        btn.disabled = true; btn.innerHTML = "جاري الحوسبة السيادية...";
        
        document.getElementById('outputSection').style.display = 'block';
        document.getElementById('imageLoader').style.display = 'block';
        document.getElementById('finalImage').style.display = 'none';

        try {
            const res = await fetch('/generate_all', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: text })
            });
            const data = await res.json();

            document.getElementById('linkedinContent').innerText = data.linkedin;
            document.getElementById('twitterContent').innerText = data.twitter;
            document.getElementById('tiktokScript').innerText = data.tiktok;
            
            // التعامل مع الصورة
            const img = document.getElementById('finalImage');
            img.src = data.image_url;
            img.onload = () => {
                document.getElementById('imageLoader').style.display = 'none';
                img.style.display = 'block';
            };
            img.onerror = () => {
                // في حال فشل التحميل، محاولة أخيرة بتبديل السيرفر
                console.log("Image failed, retrying...");
                img.src = img.src + "&retry=true";
            };

        } catch (e) { alert("حدث خطأ في النظام"); }
        btn.disabled = false; btn.innerHTML = "إطلاق الحزمة المتكاملة";
    }

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
</script>
